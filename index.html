<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NASA APTS SEOUL</title>

  <!-- Pretendard í°íŠ¸ -->
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- ì»¤ìŠ¤í…€ CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- í—¤ë” -->
  <header id="header" style="display: flex; align-items: center; gap: 10px; padding: 10px;">
    <span class="logo" style="font-size: 24px;">ğŸŒ±</span>
    <span style="font-weight: bold; font-size: 22px;">APTS</span>
    <input type="text" id="location-input" placeholder="ì§€ì—­ëª… ì…ë ¥" style="flex-grow: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc;" />
    <button id="search-btn" style="padding: 8px 12px; border-radius: 6px; border:none; background:#7bb661; color:white; cursor:pointer;">ê²€ìƒ‰</button>
  </header>

  <!-- ì»¨í…Œì´ë„ˆ -->
  <div id="container" style="display: flex; padding: 20px; gap: 20px;">
    <div id="info-panel" style="width: 320px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; padding-right: 10px;">
      <div id="aqi-box" class="info-box">
        <h3>ì˜¤ëŠ˜ì˜ ëŒ€ê¸°ì§ˆì€?</h3>
        <p id="aqi-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <div id="forecast-box" class="info-box">
        <h3>ì˜ˆìƒ ëŒ€ê¸°ì§ˆ</h3>
        <p id="forecast-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <div id="wind-box" class="info-box">
        <h3>ë°”ëŒ ë°©í–¥</h3>
        <p id="wind-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <div id="factory-warning" class="info-box alert" style="display:none; background-color: #ffdddd; color: #a00; font-weight: bold; padding: 15px; border-radius: 10px; border: 2px solid #a00; text-align: center; margin-top: 15px; animation: pulse 1.5s infinite;">
        <span class="emoji" style="font-size: 28px;">ğŸ­ ğŸ˜·</span>
        <span>ê³µì¥ ë°€ì§‘ ì§€ì—­! ë§ˆìŠ¤í¬ ì°©ìš©í•˜ì„¸ìš”!</span>
      </div>

      <div id="mood-box" class="info-box">
        <div class="mood-text">ì˜¤ëŠ˜ì˜ ëª¨ìŠµì€?</div>
        <div class="mood-image" style="font-size: 24px; margin-top: 10px;">ğŸ˜Š</div>
      </div>
    </div>

    <div id="map" style="flex: 1; min-height: 500px; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); position: relative;">
      <div id="wind-overlay" title="ë°”ëŒ ë°©í–¥" style="position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); z-index: 900; font-size: 30px; background: rgba(255, 255, 255, 0.7); padding: 6px 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <span class="arrow">â†’</span>
      </div>
      <div id="compass" style="position: absolute; top: 10px; left: 10px; width: 60px; height: 60px; background: rgba(255,255,255,0.8); border-radius: 50%; font-weight: bold; font-size: 12px; color: #333; display: flex; justify-content: center; align-items: center; z-index: 900;">
        <div class="n" style="position: absolute; top: 4px; left: 50%; transform: translateX(-50%);">N</div>
        <div class="e" style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%);">E</div>
        <div class="s" style="position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);">S</div>
        <div class="w" style="position: absolute; left: 4px; top: 50%; transform: translateY(-50%);">W</div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map').setView([37.5665, 126.9780], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const aqiText = document.getElementById('aqi-text');
    const forecastText = document.getElementById('forecast-text');
    const windText = document.getElementById('wind-text');
    const arrow = document.querySelector('#wind-overlay .arrow');
    const factoryCard = document.getElementById('factory-warning');
    const moodTextElem = document.querySelector('#mood-box .mood-text');
    const moodImageElem = document.querySelector('#mood-box .mood-image');

    // ì˜ˆì‹œ ê³µì¥ ìœ„ì¹˜
    const factoryLocations = [
      { lat: 35.87, lng: 128.60 },  // ëŒ€êµ¬
      { lat: 36.42, lng: 128.16 },  // ì„±ì£¼
      { lat: 36.41, lng: 128.16 },  // ìƒì£¼
    ];

    // ğŸ“ ì£¼ì†Œ â†’ ìœ„ë„/ê²½ë„ ë³€í™˜ using Nominatim API (OpenStreetMap)
    async function geocodeAddress(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const resp = await fetch(url);
      const data = await resp.json();
      if (data && data.length > 0) {
        const place = data[0];
        return { lat: parseFloat(place.lat), lng: parseFloat(place.lon) };
      }
      throw new Error("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // ê³µì¥ ë°€ì§‘ ì—¬ë¶€
    function isFactoryDense(lat, lng) {
      const radius = 0.3;
      return factoryLocations.some(f => {
        const dlat = lat - f.lat;
        const dlng = lng - f.lng;
        return Math.sqrt(dlat * dlat + dlng * dlng) < radius;
      });
    }

    // ì§€ì—­ë³„ ëŒ€ê¸°ì§ˆ íŒë‹¨ (ë‹¨ìˆœ ë¬¸ìì—´ í¬í•¨ìœ¼ë¡œ ì˜ˆì‹œ)
    function getInitialAQIStateByAddress(address) {
      if (address.includes("ê²½ìƒ")) return 'ë‚˜ì¨';
      if (address.includes("ì¶©ì²­")) return 'ë³´í†µ';
      if (address.includes("ì„œìš¸") || address.includes("ê²½ê¸°") || address.includes("ê°•ì›")) return 'ì¢‹ìŒ';
      return 'ì¢‹ìŒ';
    }

    // ë°”ëŒ ë°©í–¥ ì˜ˆì‹œ
    function getWindInfo(lat, lng) {
      if (lng > 128) return { direction: 'ë‚¨ì„œí’', emoji: 'â¬‹' };
      if (lat > 37.5) return { direction: 'ë¶í’', emoji: 'â¬†' };
      return { direction: 'ë™í’', emoji: 'â¡' };
    }

    // ì˜ˆì¸¡ ëŒ€ê¸°ì§ˆ ë³€í™”
    function getForecastState(aqiState) {
      const rand = Math.random() * 100;
      if (aqiState === 'ì¢‹ìŒ') return rand < 10 ? 'ë‚˜ì¨' : 'ì¢‹ìŒ';
      if (aqiState === 'ë‚˜ì¨') return rand < 80 ? 'ë‚˜ì¨' : 'ì¢‹ìŒ';
      if (aqiState === 'ë³´í†µ') return rand < 30 ? 'ë‚˜ì¨' : 'ì¢‹ìŒ';
      return aqiState;
    }

    // ì˜¤ëŠ˜ì˜ í‘œì •
    function getMoodForAQI(aqiState) {
      if (aqiState === 'ì¢‹ìŒ') return { text: 'ëª¨ë‘ í™œì§ ì›ƒê³  ìˆì–´ìš”!', emoji: 'ğŸ˜Š' };
      if (aqiState === 'ë³´í†µ') return { text: 'ì¡°ê¸ˆ ì£¼ì˜ê°€ í•„ìš”í•´ìš”', emoji: 'ğŸ˜' };
      if (aqiState === 'ë‚˜ì¨') return { text: 'ë§ˆìŠ¤í¬ ê¼­ ì°©ìš©í•˜ì„¸ìš”!', emoji: 'ğŸ˜·' };
      return { text: '', emoji: '' };
    }

    // UI ê°±ì‹ 
    function updateUI(lat, lng, address = "") {
      const initial = getInitialAQIStateByAddress(address);
      const forecast = getForecastState(initial);
      const windInfo = getWindInfo(lat, lng);

      aqiText.innerHTML = `${initial} <span class="emoji-large">${initial === 'ë‚˜ì¨' ? 'ğŸ˜·' : 'ğŸ˜Š'}</span>`;
      forecastText.innerHTML = `${forecast} <span class="emoji-large">${forecast === 'ë‚˜ì¨' ? 'ğŸ˜·' : 'ğŸ˜Š'}</span>`;
      windText.innerHTML = `${windInfo.direction} <span class="emoji-large">${windInfo.emoji}</span>`;
      arrow.textContent = windInfo.emoji;

      const mood = getMoodForAQI(initial);
      moodTextElem.textContent = mood.text;
      moodImageElem.textContent = mood.emoji;

      factoryCard.style.display = isFactoryDense(lat, lng) ? 'flex' : 'none';

      // ìƒ‰ ì¡°ì • (classëª…ì— ë§ê²Œ ì¡°ì •)
      document.getElementById('aqi-box').className = initial === 'ë‚˜ì¨' ? 'info-box bad' : 'info-box good';
      document.getElementById('forecast-box').className = forecast === 'ë‚˜ì¨' ? 'info-box bad' : 'info-box good';
    }

    // ê²€ìƒ‰ì°½, ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°
    const searchBtn = document.getElementById('search-btn');
    const locationInput = document.getElementById('location-input');

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì£¼ì†Œë¡œ ì´ë™ & UI ê°±ì‹ 
    searchBtn.addEventListener('click', async () => {
      const address = locationInput.value.trim();
      if (!address) return alert('ì§€ì—­ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      try {
        const { lat, lng } = await geocodeAddress(address);
        map.setView([lat, lng], 10);
        updateUI(lat, lng, address);
      } catch (err) {
        alert('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    });

    // ì§€ë„ ì´ë™ ì‹œ ìë™ ê°±ì‹  (ì£¼ì†ŒëŠ” ë¹„ì–´ ìˆìŒ)
    map.on('moveend', () => {
      const center = map.getCenter();
      updateUI(center.lat, center.lng);
    });

    // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • (ì„œìš¸)
    updateUI(37.5665, 126.9780, "ì„œìš¸");
  </script>

</body>
</html>